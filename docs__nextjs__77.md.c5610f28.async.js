"use strict";(self.webpackChunkblog_cq=self.webpackChunkblog_cq||[]).push([[2202],{3057:function(d,s,n){n.r(s);var r=n(72269),u=n(93359),x=n(61788),p=n(19977),v=n(91558),a=n(24268),m=n(96057),I=n(85939),o=n(53683),c=n(80936),l=n(67294),e=n(87558),t=n(85893);function i(){return(0,t.jsx)(o.dY,{children:(0,t.jsx)(l.Suspense,{fallback:(0,t.jsx)(c.Z,{}),children:(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("div",{className:"markdown",children:[(0,t.jsxs)("h2",{id:"\u524D\u8A00",children:[(0,t.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u524D\u8A00",children:(0,t.jsx)("span",{className:"icon icon-link"})}),"\u524D\u8A00"]}),(0,t.jsxs)("p",{children:[e.texts[0].value,(0,t.jsx)("a",{href:"https://juejin.cn/book/7307859898316881957/section/7309115240284127283",children:e.texts[1].value}),e.texts[2].value]}),(0,t.jsx)("p",{children:e.texts[3].value}),(0,t.jsx)(a.Z,{lang:"js",children:e.texts[4].value}),(0,t.jsx)("p",{children:e.texts[5].value}),(0,t.jsxs)("p",{children:[e.texts[6].value,(0,t.jsx)("code",{children:e.texts[7].value}),e.texts[8].value]}),(0,t.jsx)("p",{children:e.texts[9].value}),(0,t.jsx)("img",{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d64a79d94cd491f9fd2b8b597079b2c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=603\\&h=961\\&s=66492\\&e=gif\\&f=33\\&b=fefefe",width:"300"}),(0,t.jsxs)("h2",{id:"step1\u5B9E\u73B0\u6B63\u5E38\u8868\u5355\u63D0\u4EA4",children:[(0,t.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#step1\u5B9E\u73B0\u6B63\u5E38\u8868\u5355\u63D0\u4EA4",children:(0,t.jsx)("span",{className:"icon icon-link"})}),"Step1\uFF1A\u5B9E\u73B0\u6B63\u5E38\u8868\u5355\u63D0\u4EA4"]}),(0,t.jsxs)("p",{children:[e.texts[10].value,(0,t.jsx)("code",{children:e.texts[11].value}),e.texts[12].value]}),(0,t.jsxs)("p",{children:[e.texts[13].value,(0,t.jsx)("code",{children:e.texts[14].value}),e.texts[15].value]}),(0,t.jsx)(a.Z,{lang:"js",children:e.texts[16].value}),(0,t.jsxs)("p",{children:[e.texts[17].value,(0,t.jsx)("code",{children:e.texts[18].value}),e.texts[19].value,(0,t.jsx)("code",{children:e.texts[20].value}),e.texts[21].value,(0,t.jsx)("code",{children:e.texts[22].value}),e.texts[23].value,(0,t.jsx)("code",{children:e.texts[24].value}),e.texts[25].value,(0,t.jsx)("code",{children:e.texts[26].value}),e.texts[27].value]}),(0,t.jsxs)("p",{children:[e.texts[28].value,(0,t.jsx)("code",{children:e.texts[29].value}),e.texts[30].value]}),(0,t.jsx)(a.Z,{lang:"bash",children:e.texts[31].value}),(0,t.jsxs)("p",{children:[e.texts[32].value,(0,t.jsx)("code",{children:e.texts[33].value}),e.texts[34].value]}),(0,t.jsx)(a.Z,{lang:"js",children:e.texts[35].value}),(0,t.jsxs)("p",{children:[e.texts[36].value,(0,t.jsx)("code",{children:e.texts[37].value}),e.texts[38].value]}),(0,t.jsxs)("p",{children:[e.texts[39].value,(0,t.jsx)("code",{children:e.texts[40].value}),e.texts[41].value]}),(0,t.jsx)(a.Z,{lang:"js",children:e.texts[42].value}),(0,t.jsxs)("p",{children:[e.texts[43].value,(0,t.jsx)("code",{children:e.texts[44].value}),e.texts[45].value,(0,t.jsx)("code",{children:e.texts[46].value}),e.texts[47].value,(0,t.jsx)("code",{children:e.texts[48].value}),e.texts[49].value]}),(0,t.jsxs)("p",{children:[e.texts[50].value,(0,t.jsx)("code",{children:e.texts[51].value}),e.texts[52].value]}),(0,t.jsx)(a.Z,{lang:"js",children:e.texts[53].value}),(0,t.jsxs)("p",{children:[e.texts[54].value,(0,t.jsx)("code",{children:e.texts[55].value}),(0,t.jsx)("strong",{children:e.texts[56].value}),e.texts[57].value]}),(0,t.jsx)("p",{children:e.texts[58].value}),(0,t.jsx)(a.Z,{lang:"js",children:e.texts[59].value}),(0,t.jsxs)("p",{children:[e.texts[60].value,(0,t.jsx)("code",{children:e.texts[61].value}),e.texts[62].value,(0,t.jsx)("code",{children:e.texts[63].value}),e.texts[64].value]}),(0,t.jsx)("p",{children:e.texts[65].value}),(0,t.jsx)("p",{children:(0,t.jsx)("img",{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a7824f7f06149aebd57ff82ed70d811~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1396&h=968&s=510411&e=gif&f=35&b=f9f9f9",alt:"react-rsc-15.gif"})}),(0,t.jsxs)("p",{children:[e.texts[66].value,(0,t.jsx)("code",{children:e.texts[67].value}),e.texts[68].value,(0,t.jsx)("code",{children:e.texts[69].value}),e.texts[70].value]}),(0,t.jsx)("p",{children:e.texts[71].value}),(0,t.jsx)("p",{children:(0,t.jsx)("img",{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b872250515944bc293595c09acb6fa94~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1599&h=934&s=154352&e=gif&f=48&b=fdfdfd",alt:"react-rsc-10.gif"})}),(0,t.jsxs)("p",{children:[e.texts[72].value,(0,t.jsx)("code",{children:e.texts[73].value}),e.texts[74].value]}),(0,t.jsxs)("h2",{id:"step2-\u5BA2\u6237\u7AEF\u62E6\u622A\u8868\u5355\u63D0\u4EA4",children:[(0,t.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#step2-\u5BA2\u6237\u7AEF\u62E6\u622A\u8868\u5355\u63D0\u4EA4",children:(0,t.jsx)("span",{className:"icon icon-link"})}),"Step2: \u5BA2\u6237\u7AEF\u62E6\u622A\u8868\u5355\u63D0\u4EA4"]}),(0,t.jsx)("p",{children:e.texts[75].value}),(0,t.jsxs)("p",{children:[e.texts[76].value,(0,t.jsx)("code",{children:e.texts[77].value}),e.texts[78].value]}),(0,t.jsx)(a.Z,{lang:"js",children:e.texts[79].value}),(0,t.jsxs)("p",{children:[e.texts[80].value,(0,t.jsx)("code",{children:e.texts[81].value}),e.texts[82].value,(0,t.jsx)("code",{children:e.texts[83].value}),e.texts[84].value]}),(0,t.jsx)("p",{children:(0,t.jsx)("img",{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9278db4806b94d18a45488c2a5b1ea72~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1276&h=931&s=107898&e=gif&f=28&b=fcfbfc",alt:"react-rsc-16.gif"})}),(0,t.jsxs)("p",{children:[e.texts[85].value,(0,t.jsx)("code",{children:e.texts[86].value}),e.texts[87].value,(0,t.jsx)("code",{children:e.texts[88].value}),e.texts[89].value,(0,t.jsx)("code",{children:e.texts[90].value}),e.texts[91].value,(0,t.jsx)("code",{children:e.texts[92].value}),e.texts[93].value,(0,t.jsx)("code",{children:e.texts[94].value}),e.texts[95].value]}),(0,t.jsxs)("p",{children:[e.texts[96].value,(0,t.jsx)("code",{children:e.texts[97].value}),e.texts[98].value]}),(0,t.jsxs)("p",{children:[e.texts[99].value,(0,t.jsx)("code",{children:e.texts[100].value}),e.texts[101].value]}),(0,t.jsx)(a.Z,{lang:"js",children:e.texts[102].value}),(0,t.jsx)("p",{children:e.texts[103].value}),(0,t.jsx)("p",{children:(0,t.jsx)("img",{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/076c967f649d428da4f09ba67d498cf0~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1276&h=931&s=174683&e=gif&f=38&b=fcfbfc",alt:"react-rsc-17.gif"})}),(0,t.jsx)("p",{children:e.texts[104].value}),(0,t.jsxs)("p",{children:[e.texts[105].value,(0,t.jsx)("a",{href:"https://juejin.cn/book/7307859898316881957/section/7344650215729430565#heading-6",children:e.texts[106].value}),e.texts[107].value]}),(0,t.jsxs)("blockquote",{children:[(0,t.jsx)("p",{children:e.texts[108].value}),(0,t.jsxs)("ol",{children:[(0,t.jsxs)("li",{children:[e.texts[109].value,(0,t.jsxs)("ol",{children:[(0,t.jsx)("li",{children:e.texts[110].value}),(0,t.jsx)("li",{children:e.texts[111].value})]})]}),(0,t.jsx)("li",{children:e.texts[112].value})]})]}),(0,t.jsx)("p",{children:e.texts[113].value}),(0,t.jsx)("blockquote",{children:(0,t.jsxs)("ol",{children:[(0,t.jsx)("li",{children:e.texts[114].value}),(0,t.jsxs)("li",{children:[e.texts[115].value,(0,t.jsx)("a",{href:"https://github.com/mqyqingfeng/next-app-demo/tree/react-rsc-11",children:e.texts[116].value})]}),(0,t.jsxs)("li",{children:[e.texts[117].value,(0,t.jsx)("code",{children:e.texts[118].value})]})]})}),(0,t.jsxs)("h2",{id:"\u603B\u7ED3",children:[(0,t.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u603B\u7ED3",children:(0,t.jsx)("span",{className:"icon icon-link"})}),"\u603B\u7ED3"]}),(0,t.jsx)("p",{children:e.texts[119].value}),(0,t.jsx)("p",{children:e.texts[120].value}),(0,t.jsx)("p",{children:e.texts[121].value})]})})})})}s.default=i},87558:function(d,s,n){n.r(s),n.d(s,{texts:function(){return r}});const r=[{value:"\u672C\u7BC7\u6211\u4EEC\u4F1A\u5728 ",paraId:0,tocIndex:0},{value:"\u300A\u6E90\u7801\u7BC7 | \u5B9E\u73B0 Streaming\u300B",paraId:0,tocIndex:0},{value:"\u7684\u57FA\u7840\u4E0A\uFF0C\u5B9E\u73B0 Server Actions \u529F\u80FD\u3002",paraId:0,tocIndex:0},{value:"\u5982\u679C\u6CA1\u6709\u5B9E\u73B0\u4E4B\u524D\u7684\u4EE3\u7801\uFF0C\u53EF\u4EE5\u8FD0\u884C\uFF1A",paraId:1,tocIndex:0},{value:`# \u4E0B\u8F7D\u6307\u5B9A\u5206\u652F\u7684\u4EE3\u7801
git clone -b react-rsc-10 git@github.com:mqyqingfeng/next-app-demo.git
# \u8FDB\u5165\u76EE\u5F55\u5E76\u5B89\u88C5\u4F9D\u8D56\u9879
cd next-app-demo && npm i
# \u542F\u52A8
npm start
`,paraId:2,tocIndex:0},{value:"\u4E3A\u4E86\u6F14\u793A Server Actions \u7684\u6548\u679C\uFF0C\u6211\u4EEC\u5C06\u4EE5\u5B9E\u73B0\u535A\u5BA2\u8BC4\u8BBA\u529F\u80FD\u4E3A\u4F8B\u3002",paraId:3,tocIndex:0},{value:"\u5728\u5177\u4F53\u6280\u672F\u5B9E\u73B0\u4E0A\uFF0C\u6211\u4EEC\u5C06\u4F7F\u7528 ",paraId:4,tocIndex:0},{value:"<form>",paraId:4,tocIndex:0},{value:" \u5B9E\u73B0\u8BC4\u8BBA\u6846\uFF0C\u8BC4\u8BBA\u5185\u5BB9\u50A8\u5B58\u5728 JSON \u6587\u4EF6\u4E2D\u3002\u6B64\u5916\u6211\u4EEC\u4F1A\u62D3\u5C55 client.js \u4E2D\u7684\u903B\u8F91\u4EE5\u62E6\u622A\u8868\u5355\u63D0\u4EA4\uFF0C\u9632\u6B62\u63D0\u4EA4\u6570\u636E\u7684\u65F6\u5019\uFF0C\u9875\u9762\u91CD\u65B0\u52A0\u8F7D\u3002",paraId:4,tocIndex:0},{value:"\u7B80\u5355\u6765\u8BF4\u5C31\u662F\uFF0Cform \u8868\u5355\u63D0\u4EA4\u540E\uFF0C\u9875\u9762\u65E0\u5237\u65B0\uFF0C\u8BC4\u8BBA\u5217\u8868\u7ACB\u523B\u66F4\u65B0\u3002\u5C31\u50CF\u6211\u4EEC\u4F7F\u7528 Next.js \u5B9E\u73B0\u7684\u6548\u679C\u4E00\u6837\u3002\u5177\u4F53\u6548\u679C\u5982\u4E0B\uFF1A",paraId:5,tocIndex:0},{value:"\u6211\u4EEC\u5148\u5B9E\u73B0\u6B63\u5E38\u7684\u8868\u5355\u63D0\u4EA4\uFF0C\u4E5F\u5C31\u662F\u4F7F\u7528 ",paraId:6,tocIndex:1},{value:"<form>",paraId:6,tocIndex:1},{value:" \u7684 action \u5C5E\u6027\u8FDB\u884C\u63D0\u4EA4\u3002",paraId:6,tocIndex:1},{value:"\u5148\u6DFB\u52A0\u8868\u5355\u548C\u8BC4\u8BBA\u5217\u8868\u7EC4\u4EF6\uFF0C\u4FEE\u6539",paraId:7,tocIndex:1},{value:"components.tsx",paraId:7,tocIndex:1},{value:"\uFF0C\u6DFB\u52A0\u5982\u4E0B\u4EE3\u7801\uFF1A",paraId:7,tocIndex:1},{value:`export function PostPage({ slug }) {
  return (
    <Suspense fallback={<p>Loading Post...</p>}>
      <Post slug={slug} />
      <CommentForm slug={slug} />
      <CommentList slug={slug} />
    </Suspense>
  );
}

async function CommentForm({ slug }) {
  return (
    <form
      id="form"
      method="POST"
      action="/actions/comment"
      className="my-6 flex max-w-md gap-x-4 mx-auto"
    >
      <input
        name="comment"
        required
        className="min-w-0 flex-auto rounded-md border-0 bg-white/5 px-3.5 py-2 text-black shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6"
        placeholder="Enter your Comment"
      />
      <input type="hidden" name="slug" value={slug} />
      <button
        type="submit"
        className="flex-none rounded-md bg-indigo-500 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500"
      >
        Submit
      </button>
    </form>
  );
}

async function CommentList({ slug }) {
  let comments;
  try {
    const commentsData = await readFile('./comments/' + slug + '.json', 'utf8');
    comments = JSON.parse(commentsData);
  } catch (err) {
    comments = [];
  }

  return (
    <div>
      <h2>Comments:</h2>
      <div className="divide-y divide-gray-100">
        {comments.map((comment, i) => {
          return (
            <div
              key={i}
              className="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0"
            >
              <div className="text-sm font-medium leading-6 text-gray-900">
                Floor {i + 1}
              </div>
              <div className="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                {comment.content}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
`,paraId:8,tocIndex:1},{value:"\u4EE3\u7801\u5E76\u4E0D\u590D\u6742\uFF0C\u4FEE\u6539\u4E86 ",paraId:9,tocIndex:1},{value:"<PostPage>",paraId:9,tocIndex:1},{value:"\u7EC4\u4EF6\uFF0C\u65B0\u589E\u4E86 ",paraId:9,tocIndex:1},{value:"<CommentForm>",paraId:9,tocIndex:1},{value:" \u548C ",paraId:9,tocIndex:1},{value:"<CommentList>",paraId:9,tocIndex:1},{value:"\u7EC4\u4EF6\u3002\u5728 ",paraId:9,tocIndex:1},{value:"<CommentForm>",paraId:9,tocIndex:1},{value:" \u4E2D\uFF0C\u6211\u4EEC\u5C06\u8868\u5355\u6570\u636E\u63D0\u4EA4\u5230 ",paraId:9,tocIndex:1},{value:"/actions/comment",paraId:9,tocIndex:1},{value:"\uFF0C\u8868\u793A\u8FD9\u662F\u4E00\u4E2A Server Action\uFF0C\u63D0\u4EA4\u7684\u6570\u636E\u6709\u4E24\u4E2A\u5B57\u6BB5\uFF0C\u5176\u4E2D comment \u5B57\u6BB5\u8868\u793A\u5177\u4F53\u8BC4\u8BBA\u7684\u5185\u5BB9\uFF0Cslug \u5B57\u6BB5\u8868\u793A\u5177\u4F53\u662F\u54EA\u7BC7\u6587\u7AE0\u7684\u8BC4\u8BBA\u3002",paraId:9,tocIndex:1},{value:"\u6211\u4EEC\u6765\u5B9E\u73B0\u4E0B ",paraId:10,tocIndex:1},{value:"/actions/comment",paraId:10,tocIndex:1},{value:"\u8BF7\u6C42\u5904\u7406\uFF0C\u4E3A\u4E86\u66F4\u4FBF\u6377\u7684\u5904\u7406\u8868\u5355\u63D0\u4EA4\u6570\u636E\uFF0C\u6211\u4EEC\u5F15\u5165 body-parser\uFF0C\u8FD9\u662F Express \u5904\u7406 body \u975E\u5E38\u5E38\u7528\u7684\u4E00\u4E2A\u5E93\u3002\u8FD0\u884C\uFF1A",paraId:10,tocIndex:1},{value:`npm i body-parser
`,paraId:11,tocIndex:1},{value:"\u4FEE\u6539 ",paraId:12,tocIndex:1},{value:"server/ssr.ts",paraId:12,tocIndex:1},{value:"\uFF0C\u5B8C\u6574\u4EE3\u7801\u5982\u4E0B\uFF1A",paraId:12,tocIndex:1},{value:`import express from 'express';
import { readFile } from 'fs/promises';
import fetch from 'node-fetch';
import { renderToPipeableStream } from 'react-dom/server';
import { createFromNodeStream } from 'react-server-dom-webpack/client';
import bodyParser from 'body-parser';
import { serverAction } from '../actions';

const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: false }));

app.get('/:route(*)', async (req, res) => {
  const url = new URL(req.url, \`http://\${req.headers.host}\`);

  // client.js
  if (url.pathname === '/client.js') {
    const content = await readFile('./client.js', 'utf8');
    res.setHeader('Content-Type', 'text/javascript');
    res.end(content);
    return;
  }

  const response = await fetch('http://127.0.0.1:3001' + url.pathname);

  if (!response.ok) {
    res.statusCode = response.status;
    res.end();
    return;
  }
  const stream = response.body;

  // \u83B7\u53D6\u5BA2\u6237\u7AEF JSX \u5BF9\u8C61
  if (url.searchParams.has('jsx')) {
    res.set('Content-type', 'text/x-component');
    stream.on('data', (data) => {
      res.write(data);
    });
    stream.on('end', (data) => {
      res.end();
    });
  }
  // \u83B7\u53D6 HTML
  else {
    const root = await createFromNodeStream(stream, {});
    res.set('Content-type', 'text/html');
    const { pipe } = renderToPipeableStream(root);
    pipe(res);
  }
});

app.post('/actions/:route(*)', async (req, res) => {
  const url = new URL(req.url, \`http://\${req.headers.host}\`);
  if (url.pathname.startsWith('/actions/')) {
    await serverAction(req, res);
  }
});

app.listen(3000, (err) => {
  if (err) return console.error(err);
  return console.log(\`Server is listening on 3000\`);
});
`,paraId:13,tocIndex:1},{value:"Next.js \u4E2D\u7684 Server Actions \u53EA\u652F\u6301 POST \u8BF7\u6C42\uFF0C\u6240\u4EE5\u6211\u4EEC\u4E5F\u5199\u5728 POST \u8BF7\u6C42\u4E0A\u3002\u5982\u679C\u8BF7\u6C42\u4EE5 ",paraId:14,tocIndex:1},{value:"/actions",paraId:14,tocIndex:1},{value:"\u5F00\u5934\uFF0C\u5E76\u4E14\u662F POST \u8BF7\u6C42\uFF0C\u6211\u4EEC\u5C31\u8C03\u7528 serverAction \u65B9\u6CD5\u3002",paraId:14,tocIndex:1},{value:"\u65B0\u5EFA ",paraId:15,tocIndex:1},{value:"actions.ts",paraId:15,tocIndex:1},{value:"\uFF0C\u5199\u5165\u5177\u4F53\u7684 serverAction \u51FD\u6570\uFF1A",paraId:15,tocIndex:1},{value:`export async function serverAction(req, res) {
  const action = req.url.slice(9);

  const module = await import('./actions/' + action + '.js');
  const actionFunction = module.default;
  await actionFunction(req, res);

  res.redirect(302, '/' + req.body.slug);
}
`,paraId:16,tocIndex:1},{value:"\u6211\u4EEC\u4F7F\u7528 Next.js Server Actions \u7684\u65F6\u5019\uFF0C\u5F80\u5F80\u4F1A\u65B0\u5EFA\u4E00\u4E2A ",paraId:17,tocIndex:1},{value:"actions.js",paraId:17,tocIndex:1},{value:"\uFF0C\u7136\u540E\u5728\u5176\u4E2D\u5199\u5165\u5177\u4F53\u7684\u903B\u8F91\u5904\u7406\uFF0C\u6362\u53E5\u8BDD\u8BF4\uFF0C\u5177\u4F53\u5904\u7406\u7684\u903B\u8F91\u7531\u7528\u6237\u5B9A\u4E49\u3002\u8FD9\u91CC\u6211\u4EEC\u4E5F\u662F\u4EA4\u7ED9\u7528\u6237\u6765\u5B9A\u4E49\uFF0C\u5982\u679C\u8BF7\u6C42\u7684\u662F ",paraId:17,tocIndex:1},{value:"/actions/comment",paraId:17,tocIndex:1},{value:" \u5BF9\u5E94\u7684\u5904\u7406\u4EE3\u7801\u5C31\u5728 ",paraId:17,tocIndex:1},{value:"/actions/comment.js",paraId:17,tocIndex:1},{value:"\u4E2D\u3002",paraId:17,tocIndex:1},{value:"\u65B0\u5EFA ",paraId:18,tocIndex:1},{value:"actions/comment.ts",paraId:18,tocIndex:1},{value:"\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A",paraId:18,tocIndex:1},{value:`import { readFile, writeFile } from 'fs/promises';

export default async function handleCommentPost(req, res) {
  const { slug, comment } = req.body;

  let comments;

  try {
    const commentsData = await readFile('./comments/' + slug + '.json', 'utf8');
    comments = JSON.parse(commentsData);
  } catch (err) {
    if (err.code === 'ENOENT') {
      comments = [];
    } else {
      throw err;
    }
  }

  comments.push({
    content: comment,
  });

  const commentsFile = './comments/' + slug + '.json';
  await writeFile(commentsFile, JSON.stringify(comments, null, 2));
}
`,paraId:19,tocIndex:1},{value:"\u5904\u7406\u7684\u4EE3\u7801\u5E76\u4E0D\u590D\u6742\uFF0C\u8BFB\u53D6\u4FDD\u5B58\u6570\u636E\u7684 json \u6587\u4EF6\uFF0C\u7136\u540E\u5199\u5165\u65B0\u7684\u6570\u636E\u3002\u76EE\u524D\u8FD8\u6CA1\u6709\u5EFA\u7ACB json \u6587\u4EF6\uFF0C**\u6211\u4EEC\u5148\u65B0\u5EFA **",paraId:20,tocIndex:1},{value:"**comments**",paraId:20,tocIndex:1},{value:"\u6587\u4EF6\u5939\uFF0C\u9632\u6B62\u51FA\u73B0\u8BFB\u53D6\u9519\u8BEF",paraId:20,tocIndex:1},{value:"\u3002",paraId:20,tocIndex:1},{value:"\u6B64\u65F6\u6D89\u53CA\u5230\u7684\u6587\u4EF6\u76EE\u5F55\u7ED3\u6784\u5982\u4E0B\uFF1A",paraId:21,tocIndex:1},{value:`next-app-demo
\u251C\u2500 actions
\u2502  \u2514\u2500 comment.ts
\u251C\u2500 comments
\u251C\u2500 server
\u2502  \u251C\u2500 rsc.ts
\u2502  \u2514\u2500 ssr.ts
\u251C\u2500 actions.ts
\u251C\u2500 components.tsx
`,paraId:22,tocIndex:1},{value:"\u5728 ",paraId:23,tocIndex:1},{value:"actions.ts",paraId:23,tocIndex:1},{value:"\u4E2D\uFF0C\u6700\u540E\u6211\u4EEC\u8C03\u7528\u4E86 ",paraId:23,tocIndex:1},{value:"res.redirect",paraId:23,tocIndex:1},{value:"\u8FD4\u56DE\u4E4B\u524D\u7684\u9875\u9762\u3002",paraId:23,tocIndex:1},{value:"\u6B64\u65F6\u4EA4\u4E92\u6548\u679C\u5982\u4E0B\uFF1A",paraId:24,tocIndex:1},{value:"\u8868\u5355\u6570\u636E\u6210\u529F\u63D0\u4EA4\u548C\u6E32\u67D3\u3002\u5176\u5B9E\u73B0\u903B\u8F91\u662F\uFF0CForm \u8868\u5355\u6570\u636E\u63D0\u4EA4\u5230 ",paraId:25,tocIndex:1},{value:"/actions/comment",paraId:25,tocIndex:1},{value:"\uFF0C\u5BF9\u5E94\u8BFB\u53D6 ",paraId:25,tocIndex:1},{value:"/actions/comment.js",paraId:25,tocIndex:1},{value:"\u6587\u4EF6\u8FDB\u884C\u5904\u7406\uFF0C\u7136\u540E\u91CD\u5B9A\u5411\u56DE\u5230\u4E4B\u524D\u7684\u9875\u9762\uFF0C\u9875\u9762\u91CD\u65B0\u52A0\u8F7D\uFF0C\u8BC4\u8BBA\u5217\u8868\u6570\u636E\u66F4\u65B0\u3002",paraId:25,tocIndex:1},{value:"\u56E0\u4E3A\u6211\u4EEC\u7528\u7684\u662F form \u7684 action \u63D0\u4EA4\u7684\u6570\u636E\uFF0C\u6240\u4EE5\u5373\u4F7F\u7981\u7528 JavaScript\uFF0C\u8868\u5355\u4E5F\u662F\u53EF\u4EE5\u6210\u529F\u63D0\u4EA4\u7684\u3002\u7981\u7528 JavaScript \u7684\u6548\u679C\u5982\u4E0B\uFF1A",paraId:26,tocIndex:1},{value:"\u6CE8\uFF1A\u8FD9\u91CC\u7684\u6F14\u793A\uFF0C\u6211\u4EEC\u5220\u9664\u4E86 Suspense \u7EC4\u4EF6\uFF0C\u56E0\u4E3A Suspense \u9700\u8981\u4F9D\u8D56 JS\uFF0C\u5728\u83B7\u5F97\u6570\u636E\u540E\uFF0C\u66F4\u65B0 DOM \u8282\u70B9\u3002\u6B64\u5916\u56E0\u4E3A\u6211\u4EEC\u7684 tailwind.css \u662F\u901A\u8FC7 ",paraId:27,tocIndex:1},{value:"<script>",paraId:27,tocIndex:1},{value:"\u6807\u7B7E\u5F15\u5165\u7684\uFF0C\u6240\u4EE5\u7981\u7528 JavaScript \u65F6\uFF0C\u6837\u5F0F\u5931\u6548\u3002\u4F46\u662F\u8868\u5355\u4F9D\u7136\u53EF\u4EE5\u6B63\u5E38\u63D0\u4EA4\u3002",paraId:27,tocIndex:1},{value:"\u4F46\u662F\u5728 Next.js \u4E2D\uFF0C\u4F7F\u7528 Server Action \u63D0\u4EA4\u8868\u5355\uFF0C\u9875\u9762\u662F\u4E0D\u4F1A\u5237\u65B0\u7684\u3002\u8FD9\u662F\u56E0\u4E3A\u5BA2\u6237\u7AEF\u62E6\u622A\u4E86\u8868\u5355\u63D0\u4EA4\u3002",paraId:28,tocIndex:2},{value:"\u4FEE\u6539 ",paraId:29,tocIndex:2},{value:"client.js",paraId:29,tocIndex:2},{value:"\uFF0C\u6DFB\u52A0\u5982\u4E0B\u4EE3\u7801\uFF1A",paraId:29,tocIndex:2},{value:`window.addEventListener('submit', async (e) => {
  const action = e.target.action;
  const actionURL = new URL(action, window.location.origin);

  if (!actionURL.pathname.startsWith('/actions/')) {
    return;
  }

  e.preventDefault();

  if (e.target.method === 'post') {
    const formData = new FormData(e.target);
    const body = Object.fromEntries(formData.entries());
    const response = await fetch(action, {
      method: 'POST',
      body: JSON.stringify(body),
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) return;
    navigate(window.location.pathname, true);
    return;
  } else {
    console.error('unknown method', e.target.method);
  }
});
`,paraId:30,tocIndex:2},{value:"\u8FD9\u6BB5\u4EE3\u7801\u903B\u8F91\u5E76\u4E0D\u590D\u6742\uFF0C\u9996\u5148\u662F\u963B\u6B62\u8868\u5355\u63D0\u4EA4\uFF0C\u7136\u540E\u662F\u4EE5 POST \u8BF7\u6C42\u8C03\u7528 ",paraId:31,tocIndex:2},{value:"/actions/comment",paraId:31,tocIndex:2},{value:"\uFF0C\u5177\u4F53\u8FD4\u56DE\u7684\u6570\u636E\u6211\u4EEC\u5E76\u672A\u5904\u7406\uFF0C\u4E3B\u8981\u662F\u89E6\u53D1\u5BF9\u5E94 ",paraId:31,tocIndex:2},{value:"/actions/comment.ts",paraId:31,tocIndex:2},{value:"\u4EE3\u7801\u7684\u6267\u884C\uFF0C\u6700\u540E\u8C03\u7528 navigate \u51FD\u6570\u91CD\u65B0\u6E32\u67D3\u9875\u9762\u3002\u4EA4\u4E92\u6548\u679C\u5982\u4E0B\uFF1A",paraId:31,tocIndex:2},{value:"\u4F60\u4F1A\u53D1\u73B0\uFF0C\u5F88\u5947\u602A\uFF0C\u8BC4\u8BBA\u5E76\u6CA1\u6709\u66F4\u65B0\u3002\u6309\u7406\u8BF4\uFF0C\u63D0\u4EA4\u7684\u65F6\u5019\u5E94\u8BE5\u6709 3 \u4E2A\u8BF7\u6C42\u4EA7\u751F\uFF0C\u9996\u5148\u662F ",paraId:32,tocIndex:2},{value:"/actions/comment",paraId:32,tocIndex:2},{value:"\u8BF7\u6C42\uFF0C\u7531\u5BA2\u6237\u7AEF\u89E6\u53D1\uFF0C",paraId:32,tocIndex:2},{value:"actions.ts",paraId:32,tocIndex:2},{value:"\u4EE3\u7801\u91CD\u5B9A\u5411\u5230\u539F\u9875\u9762\uFF0C\u4E8E\u662F\u89E6\u53D1\u4E86\u7B2C 2 \u4E2A ",paraId:32,tocIndex:2},{value:"earth",paraId:32,tocIndex:2},{value:" \u8BF7\u6C42\uFF0C\u5BA2\u6237\u7AEF\u540C\u65F6\u6267\u884C\u4E86 ",paraId:32,tocIndex:2},{value:"naviagte",paraId:32,tocIndex:2},{value:" \u51FD\u6570\uFF0C\u89E6\u53D1\u7B2C\u4E09\u4E2A ",paraId:32,tocIndex:2},{value:"/earth?jsx",paraId:32,tocIndex:2},{value:"\u8BF7\u6C42\u3002",paraId:32,tocIndex:2},{value:"\u4F46\u662F\u73B0\u5728\u53EA\u6709 2 \u4E2A\u8BF7\u6C42\uFF0C\u6CA1\u6709\u7B2C 3 \u4E2A ",paraId:33,tocIndex:2},{value:"/earth?jsx",paraId:33,tocIndex:2},{value:"\u8BF7\u6C42\u3002\u8FD9\u662F\u56E0\u4E3A\u6211\u4EEC\u5728\u4E4B\u524D\u7684\u5B9E\u73B0\u4E2D\u5B9E\u73B0\u4E86\u5BA2\u6237\u7AEF\u8DEF\u7531\u7F13\u5B58\uFF0C\u6240\u4EE5\u7528\u4E86\u7F13\u5B58\u4E2D\u7684\u6570\u636E\u3002",paraId:33,tocIndex:2},{value:"\u7EE7\u7EED\u4FEE\u6539 ",paraId:34,tocIndex:2},{value:"client.js",paraId:34,tocIndex:2},{value:"\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A",paraId:34,tocIndex:2},{value:`async function navigate(pathname, revalidate) {
  currentPathname = pathname;
  if (!revalidate && clientJSXCache[pathname]) {
    updateRoot(clientJSXCache[pathname]);
    return;
  } else {
    const response = fetch(pathname + '?jsx');
    const root = await createFromFetch(response);
    clientJSXCache[pathname] = root;
    startTransition(() => {
      updateRoot(root);
    });
  }
}
`,paraId:35,tocIndex:2},{value:"\u6211\u4EEC\u6DFB\u52A0\u4E86\u4E00\u4E2A revalidate \u53D8\u91CF\uFF0C\u5F53\u4E3A true \u7684\u65F6\u5019\uFF0C\u4E0D\u8BFB\u53D6\u7F13\u5B58\uFF0C\u91CD\u65B0\u8BF7\u6C42\u3002\u6B64\u65F6\u9875\u9762\u6B63\u5E38\u8FD0\u884C\uFF1A",paraId:36,tocIndex:2},{value:"\u6CE8\uFF1A\u63D0\u4EA4\u7684\u65F6\u5019\u4E4B\u6240\u4EE5\u4F1A\u6709\u5361\u987F\u611F\uFF0C\u662F\u56E0\u4E3A\u6211\u4EEC\u4E3A\u6587\u7AE0\u6DFB\u52A0\u4E86 2s \u5EF6\u8FDF\u3002",paraId:37,tocIndex:2},{value:"\u60F3\u60F3 ",paraId:38,tocIndex:2},{value:"\u300A\u7F13\u5B58\u7BC7 | Caching\uFF08\u4E0B\uFF09\u300B",paraId:38,tocIndex:2},{value:"\u4E2D\uFF0C\u6211\u4EEC\u8BB2\u5230\u5BA2\u6237\u7AEF\u8DEF\u7531\u7F13\u5B58\u7684\u5931\u6548\u65B9\u5F0F\uFF1A",paraId:38,tocIndex:2},{value:"\u6709\u4E24\u79CD\u65B9\u6CD5\u53EF\u4EE5\u8BA9\u8DEF\u7531\u7F13\u5B58\u5931\u6548\uFF1A",paraId:39,tocIndex:2},{value:`\u5728 Server Action \u4E2D
`,paraId:40,tocIndex:2},{value:"\u901A\u8FC7 revalidatePath \u6216 revalidateTag \u91CD\u65B0\u9A8C\u8BC1\u6570\u636E",paraId:41,tocIndex:2},{value:"\u4F7F\u7528 cookies.set \u6216\u8005 cookies.delete \u4F1A\u4F7F\u8DEF\u7531\u7F13\u5B58\u5931\u6548\uFF0C\u8FD9\u662F\u4E3A\u4E86\u9632\u6B62\u4F7F\u7528 cookie \u7684\u8DEF\u7531\u8FC7\u65F6\uFF08\u5982\u8EAB\u4EFD\u9A8C\u8BC1\uFF09",paraId:41,tocIndex:2},{value:"\u8C03\u7528 router.refresh \u4F1A\u4F7F\u8DEF\u7531\u7F13\u5B58\u5931\u6548\u5E76\u53D1\u8D77\u4E00\u4E2A\u91CD\u65B0\u83B7\u53D6\u5F53\u524D\u8DEF\u7531\u7684\u8BF7\u6C42",paraId:40,tocIndex:2},{value:"\u6211\u4EEC\u8FD9\u91CC\u7684\u5B9E\u73B0\u5C31\u662F\u4E00\u4E2A\u7B80\u6613\u7684 Server Action revalidate \u529F\u80FD\u3002",paraId:42,tocIndex:2},{value:"\u529F\u80FD\u5B9E\u73B0\uFF1AServer Action",paraId:43,tocIndex:2},{value:"\u6E90\u7801\u5730\u5740\uFF1A",paraId:43,tocIndex:2},{value:"https://github.com/mqyqingfeng/next-app-demo/tree/react-rsc-11",paraId:43,tocIndex:2},{value:"\u4E0B\u8F7D\u4EE3\u7801\uFF1A",paraId:43,tocIndex:2},{value:"git clone -b react-rsc-11 git@github.com:mqyqingfeng/next-app-demo.git",paraId:43,tocIndex:2},{value:"\u81F3\u6B64\uFF0C\u6211\u4EEC\u7684 Server Actions \u529F\u80FD\u5C31\u5B9E\u73B0\u4E86\uFF0C\u5176\u5B9E\u8DDF Next.js \u7684\u5B9E\u73B0\u6709\u5F88\u5927\u7684\u5DEE\u522B\u3002",paraId:44,tocIndex:3},{value:"\u5728 Next.js \u4E2D\uFF0CServer Actions \u7684\u8BF7\u6C42\u662F\u4EE5 POST \u8BF7\u6C42\u63D0\u4EA4\u5230\u5F53\u524D\u9875\u9762\u7684 URL\uFF0C\u63D0\u4EA4\u7684\u65F6\u5019\u4F1A\u643A\u5E26 $ACTION_ID \u4EE5\u533A\u5206\u4E0D\u540C\u7684 Server Action\u3002\u540C\u65F6 Next.js \u4F1A\u5728\u8FD9\u4E00\u6B21\u8BF7\u6C42\u4E2D\u8FD4\u56DE\u6240\u6709\u9700\u8981\u7684\u4FE1\u606F\uFF0C\u7136\u540E\u66F4\u65B0\u72B6\u6001\uFF0C\u4E0D\u50CF\u6211\u4EEC\u8FD9\u822C\u7B80\u5355\u7C97\u66B4\u7684\u91CD\u65B0\u8BF7\u6C42\u3002",paraId:45,tocIndex:3},{value:"\u4F46\u539F\u7406\u662F\u7C7B\u4F3C\u7684\uFF0C\u5E0C\u671B\u8FD9\u4E2A\u7B80\u5355\u7684 Server Actions \u5B9E\u73B0\u5BF9\u5927\u5BB6\u7406\u89E3 Next.js \u7684\u5B9E\u73B0\u6709\u6240\u5E2E\u52A9\u3002",paraId:46,tocIndex:3}]}}]);
